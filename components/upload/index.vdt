import Button from '../button';
import Progress from '../progress';
import {expandAnimationCallbacks} from '../utils';

const {
    className, style, accept, multiple,
    files, children, type, _dragOver, listType
} = self.get();

const classNameObj = {
    'k-upload': true,
    [className]: className,
    'k-drag': type === 'drag', 
    'k-dragover': _dragOver,
    'k-gallery': listType === 'gallery',
};

const events = {
    'ev-click': self._selectFile,
};
if (type === 'drag') {
    events['ev-dragover'] = self._preventDefault;
    events['ev-dragenter'] = self._onDragEnter;
    events['ev-dragleave'] = self._onDragLeave;
    events['ev-drop'] = self._onDrop;
}

const handle = (
    <div class="k-handle" {{ ...events }} ref="handle">
        <b:content>
            <b:children v-if={{ children }}>{{ children }}</b:children>
            <b:_list v-if={{ listType !== 'gallery' }}>
                <Button type="primary" v-if={{ type === 'select' }}>点击上传</Button>
                <div class="k-area" v-else>
                    <i class="k-icon ion-upload"></i>
                    <div>将文件拖到此处，或点击上传</div>
                </div>
            </b:_list>
            <b:_list v-else>
                <i class="k-picture-card k-add ion-ios-plus-empty"></i>
            </b:_list>
        </b:content>
    </div>
);

<div class={{ classNameObj }} style={{ style }}>
    <input type="file" 
        accept={{ accept }}
        class="c-hidden" 
        ref="input" 
        ev-change={{ self._onInputChange}}
        multiple={{ multiple }}
    />
    <Animate class="k-pictures" 
        key="pictures" 
        a:disabled
        v-if={{ listType === 'gallery' }}
    >
        <Animate 
            class={{ {
                "k-picture k-picture-card": true, 
                'k-error': value.status === 'error'
            } }}
            v-for={{ files }}
            key={{ value.uid }}
            a:transition="dropdown"
        >
            <img src={{ value.url }} />
            <Animate class="k-overlap" a:transition="fade" key="overlap"
                v-if={{ value.status !== 'done' && value.status !== 'error' }}
            >
                <Progress percent={{ value.percent }} size="mini" />
            </Animate>
            <Button type="none" icon size="mini" class="k-close"
                ev-click={{ self._removeFile.bind(self, value, key) }}
            >
                <i class="k-icon ion-ios-close"></i>
            </Button>
        </Animate>
        <Animate key="handle"
            a:transition="dropdown"
            class="c-middle"
        >{{ handle }}</Animate>
    </Animate>
    <b:_handle v-else>{{ handle }}</b:_handle>
    <div class="k-tip" v-if={{ blocks.tip }}><b:tip /></div>
    <div class="k-files" v-if={{ listType !== 'gallery' }}>
        <Animate v-for={{ files }} 
            class={{ {"k-file": true, 'k-error': value.status === 'error'} }}
            key={{ value.uid }}
            a:transition="expand"
            {{ ...expandAnimationCallbacks }}
        >
            <div class="k-wrapper">
                <div class="k-name c-ellipsis">
                    <i class="k-file-icon ion-document"></i>
                    {{ value.name }}
                    <div class="k-icons">
                        <Button type="none" icon size="mini" class="k-close"
                            ev-click={{ self._removeFile.bind(self, value, key) }}
                        >
                            <i class="k-icon ion-ios-close-empty"></i>
                        </Button>
                        <i class="k-status-icon ion-ios-checkmark-outline" v-if={{ value.status === 'done' }}></i>
                        <i class="k-status-icon ion-ios-close-outline" v-if={{ value.status === 'error' }}></i>
                    </div>
                </div>
                <Animate key="progress" 
                    a:transition="expand" 
                    v-if={{ value.status !== 'done' && value.status !== 'error' }}
                    {{ ...expandAnimationCallbacks }}
                >
                    <Progress percent={{ value.percent }} size="mini" />
                </Animate>
            </div>
        </Animate>
    </div>
</div>
